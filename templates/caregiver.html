{% extends "base.html" %}

{% block title %}Caregiver Dashboard - CellGuard{% endblock %}

{% block content %}
<div class="predictions-page">
  <div class="container">
    <div class="prediction-grid">
      <!-- Caregiver Overview Section -->
      <section class="monitoring-section">
        <h2>Caregiver Dashboard</h2>
        <p>Monitor and manage your patients' health status.</p>
        <div class="grid-2">
          <!-- Patient Overview -->
          <div class="card">
            <h3>My Patients</h3>
            <div class="patient-list">
              {% for patient in patients %}
              <div class="patient-card">
                <div class="patient-info">
                  <div class="patient-name">{{ patient.patient.name }}</div>
                  <div class="patient-status {% if patient.latest_prediction and patient.latest_prediction.crisis_predicted %}status-danger{% elif patient.latest_prediction and patient.latest_prediction.crisis_probability > 0.5 %}status-warning{% else %}status-normal{% endif %}">
                    {% if patient.latest_prediction %}
                      {% if patient.latest_prediction.crisis_predicted %}
                        High Risk
                      {% elif patient.latest_prediction.crisis_probability > 0.5 %}
                        Moderate Risk
                      {% else %}
                        Low Risk
                      {% endif %}
                    {% else %}
                      No Data
                    {% endif %}
                  </div>
                </div>
                <div class="patient-vitals">
                  <div class="vital-stat">
                    <i class="fas fa-thermometer-half"></i>
                    {{ patient.latest_reading.temperature|round(1) if patient.latest_reading else '--' }}°C
                  </div>
                  <div class="vital-stat">
                    <i class="fas fa-lungs"></i>
                    {{ patient.latest_reading.spo2|round(0) if patient.latest_reading else '--' }}%
                  </div>
                </div>
                <div class="patient-actions">
                  <button class="btn btn-primary btn-sm" onclick="viewPatientDetails({{ patient.patient.id }})">View Details</button>
                  <button class="btn btn-outline btn-sm" onclick="contactPatient({{ patient.patient.id }})">Contact</button>
                </div>
              </div>
              {% endfor %}
            </div>
            <button class="btn btn-primary" style="margin-top: 1rem" onclick="addNewPatient()">
              <i class="fas fa-plus"></i> Add New Patient
            </button>
          </div>

          <!-- Alerts & Notifications -->
          <div class="card">
            <h3>Recent Alerts</h3>
            <div class="alert-list">
              {% for alert in alerts %}
              <div class="alert-card {{ alert.severity }}">
                <div class="alert-header">
                  <div class="alert-title">{{ alert.title }}</div>
                  <div class="alert-time">{{ alert.time_ago }}</div>
                </div>
                <div class="alert-patient">{{ alert.patient_name }}</div>
                <div class="alert-details">{{ alert.details }}</div>
                <div class="alert-actions">
                  <button class="btn btn-primary btn-sm" onclick="viewAlert({{ alert.id }})">View Details</button>
                  <button class="btn btn-outline btn-sm" onclick="markAsRead({{ alert.id }})">Mark as Read</button>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </section>

      <!-- Patient Details Modal -->
      <div id="patientDetailsModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Patient Details</h2>
            <span class="close">&times;</span>
          </div>
          <div class="modal-body">
            <div class="patient-details">
              <!-- Patient details will be loaded here -->
            </div>
            <div class="vital-signs-chart">
              <canvas id="vitalSignsChart"></canvas>
            </div>
            <div class="medication-schedule">
              <h3>Medication Schedule</h3>
              <!-- Medication schedule will be loaded here -->
            </div>
            <div class="recent-symptoms">
              <h3>Recent Symptoms</h3>
              <!-- Recent symptoms will be loaded here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Add Patient Modal -->
      <div id="addPatientModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Add New Patient</h2>
            <span class="close">&times;</span>
          </div>
          <div class="modal-body">
            <form id="addPatientForm">
              <div class="form-group">
                <label for="patientEmail">Patient's Email</label>
                <input type="email" id="patientEmail" required>
              </div>
              <div class="form-group">
                <label for="relationship">Relationship</label>
                <select id="relationship" required>
                  <option value="parent">Parent</option>
                  <option value="spouse">Spouse</option>
                  <option value="sibling">Sibling</option>
                  <option value="child">Child</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label for="phone">Your Phone Number</label>
                <input type="tel" id="phone" required>
              </div>
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="emergencyContact" checked>
                  I am an emergency contact for this patient
                </label>
              </div>
              <button type="submit" class="btn btn-primary">Add Patient</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Initialize socket connection
  const socket = io();

  // Listen for real-time updates
  socket.on('patient_update', function(data) {
    updatePatientCard(data);
  });

  function updatePatientCard(data) {
    const patientCard = document.querySelector(`[data-patient-id="${data.patient_id}"]`);
    if (patientCard) {
      // Update vital signs
      patientCard.querySelector('.temperature').textContent = `${data.temperature.toFixed(1)}°C`;
      patientCard.querySelector('.spo2').textContent = `${data.spo2}%`;

      // Update risk status
      const statusElement = patientCard.querySelector('.patient-status');
      if (data.crisis_predicted) {
        statusElement.className = 'patient-status status-danger';
        statusElement.textContent = 'High Risk';
      } else if (data.crisis_probability > 0.5) {
        statusElement.className = 'patient-status status-warning';
        statusElement.textContent = 'Moderate Risk';
      } else {
        statusElement.className = 'patient-status status-normal';
        statusElement.textContent = 'Low Risk';
      }
    }
  }

  function viewPatientDetails(patientId) {
    // Load and display patient details
    fetch(`/api/patient/${patientId}/details`)
      .then(response => response.json())
      .then(data => {
        displayPatientDetails(data);
        document.getElementById('patientDetailsModal').style.display = 'block';
      });
  }

  function displayPatientDetails(data) {
    const detailsDiv = document.querySelector('#patientDetailsModal .patient-details');
    if (!data || !data.patient) {
      detailsDiv.innerHTML = '<p>No details available.</p>';
      return;
    }
    detailsDiv.innerHTML = `
      <h4>${data.patient.name} (${data.patient.email})</h4>
      <h5>Recent Vitals:</h5>
      <ul>
        ${data.readings.map(r => `<li>${r.timestamp}: Temp ${r.temperature}°C, SpO2 ${r.spo2}%, GSR ${r.gsr}</li>`).join('')}
      </ul>
      <h5>Recent Predictions:</h5>
      <ul>
        ${data.predictions.map(p => `<li>${p.timestamp}: Probability ${Math.round(p.probability*100)}%, Crisis: ${p.predicted ? 'Yes' : 'No'}</li>`).join('')}
      </ul>
    `;
  }

  function contactPatient(patientId) {
    alert('Contact functionality coming soon!');
  }

  function addNewPatient() {
    document.getElementById('addPatientModal').style.display = 'block';
  }

  // Robust modal close logic
  document.querySelectorAll('.close').forEach(closeBtn => {
    closeBtn.onclick = function() {
      this.closest('.modal').style.display = 'none';
    }
  });

  window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
      event.target.style.display = 'none';
    }
  }

  // Add a cancel button to the add patient modal
  const addPatientModal = document.getElementById('addPatientModal');
  if (addPatientModal) {
    let cancelBtn = addPatientModal.querySelector('.cancel-btn');
    if (!cancelBtn) {
      const footer = addPatientModal.querySelector('.modal-body');
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-outline cancel-btn';
      btn.textContent = 'Cancel';
      btn.style.marginLeft = '1rem';
      btn.onclick = function() {
        addPatientModal.style.display = 'none';
      };
      footer.appendChild(btn);
    }
  }

  // Handle add patient form submission
  document.getElementById('addPatientForm').onsubmit = function(e) {
    e.preventDefault();
    const formData = {
      patient_email: document.getElementById('patientEmail').value,
      relationship: document.getElementById('relationship').value,
      phone: document.getElementById('phone').value,
      emergency_contact: document.getElementById('emergencyContact').checked
    };

    fetch('/api/caregiver/add_patient', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('addPatientModal').style.display = 'none';
        location.reload();
      } else {
        alert(data.error);
      }
    });
  };
</script>
{% endblock %} 